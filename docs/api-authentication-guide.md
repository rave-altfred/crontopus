# API Authentication & Migration Guide

**Phase 17 Implementation** - November 2025

This guide explains the authentication system implemented in Phase 17 and provides migration instructions for existing deployments.

---

## Overview

Phase 17 introduced three major security enhancements:

1. **Phase 17.1**: Check-in Authentication (endpoint tokens)
2. **Phase 17.2**: User API Tokens (programmatic access)
3. **Phase 17.3**: Rate Limiting (DDoS protection)

All three components are **fully deployed and operational** as of November 17, 2025.

---

## Authentication Methods

### 1. JWT Tokens (Session-Based)

**Use Case**: Web UI, CLI tool

**Characteristics**:
- Short-lived (7 days expiry)
- Tied to user session
- Automatically refreshed by frontend
- Stored in browser localStorage or CLI config

**Obtain Token**:
```bash
# Via CLI
crontopus auth login
# Token stored in ~/.crontopus/token

# Via API
curl -X POST https://crontopus.com/api/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=alice&password=secret123"
```

**Use Token**:
```bash
curl -H "Authorization: Bearer <jwt_token>" \
  https://crontopus.com/api/runs
```

---

### 2. API Tokens (Long-Lived)

**Use Case**: CI/CD pipelines, automation scripts, integrations

**Format**: `ctp_<random_string>` (32+ characters)

**Characteristics**:
- Long-lived (90 days, 1 year, or never expires)
- Shown **once** during creation (SHA256 hash stored)
- Automatic `last_used_at` tracking for audit
- Revocable at any time
- Scoped permissions (Phase 19 - planned)

**Create Token**:

**Option A - Web UI** (Recommended):
1. Login to https://crontopus.com
2. Navigate to Settings → API Tokens
3. Click "Create Token"
4. Enter name and select scopes
5. Set expiration (optional)
6. **Copy token immediately** (shown only once!)

**Option B - API**:
```bash
# Create token via API (requires JWT)
curl -X POST https://crontopus.com/api/tokens \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "CI/CD Pipeline",
    "scopes": ["read:runs", "write:jobs"],
    "expires_in_days": 90
  }'

# Response (SAVE THIS - shown only once!)
{
  "id": 123,
  "name": "CI/CD Pipeline",
  "token": "ctp_aBcDeFgHiJkLmNoPqRsTuVwXyZ123456789",
  "scopes": ["read:runs", "write:jobs"],
  "expires_at": "2026-02-15T10:30:00Z"
}
```

**Use Token**:
```bash
export CRONTOPUS_API_TOKEN="ctp_aBcDeFgHiJkLmNoPqRsTuVwXyZ"

curl -H "Authorization: Bearer $CRONTOPUS_API_TOKEN" \
  https://crontopus.com/api/runs
```

**Revoke Token**:
```bash
# Via Web UI: Settings → API Tokens → Revoke button

# Via API:
curl -X DELETE https://crontopus.com/api/tokens/123 \
  -H "Authorization: Bearer <jwt_or_api_token>"
```

---

### 3. Endpoint Tokens (Agent Authentication)

**Use Case**: Agent enrollment, heartbeats, job check-ins

**Format**: `ep_<random_string>` (generated by backend)

**Characteristics**:
- Unique per agent/endpoint
- bcrypt hashed in database
- Stored in `~/.crontopus/agent-token` (file permissions 0600)
- Used for all agent API calls
- Prevents fake job check-ins

**How It Works**:
```
1. User creates enrollment token via Web UI
2. Agent enrolls using enrollment token
3. Backend generates unique endpoint token
4. Agent saves token to ~/.crontopus/agent-token
5. All subsequent API calls use endpoint token
6. Job check-ins validate endpoint token
```

**Agent Enrollment**:
```bash
# Agent configuration includes enrollment token
backend:
  api_url: "https://crontopus.com"
  enrollment_token: "<from_web_ui>"

# Agent automatically:
# 1. Enrolls with backend
# 2. Receives endpoint token
# 3. Saves token to ~/.crontopus/agent-token
# 4. Uses token for all future API calls
```

**Check-in Authentication**:
```bash
# Automatic via helper script
~/.crontopus/bin/checkin reads ~/.crontopus/agent-token

# Manual check-in (for testing)
curl -X POST https://crontopus.com/api/checkins \
  -H "Authorization: Bearer <endpoint_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "job_name": "backup-database",
    "namespace": "production",
    "endpoint_id": 456,
    "status": "success"
  }'
```

---

## Rate Limiting

### Overview

**Infrastructure**: fastapi-limiter 0.1.6 + Valkey (Redis fork)

**Protected Endpoints**: 28 endpoints across authentication, jobs, runs, agents, tokens

### Rate Limit Table

| Endpoint | Limit | Reasoning |
|----------|-------|-----------|
| POST /auth/login | 5 req/min | Prevent brute force |
| POST /auth/register | 3 req/hour | Prevent spam accounts |
| POST /checkins | 100 req/min | High-frequency jobs |
| POST /api/jobs | 30 req/min | Job creation rate |
| GET /api/runs | 60 req/min | Standard API usage |
| POST /api/tokens | 10 req/min | Token creation |
| POST /endpoints/enroll | 10 req/min | Agent enrollment |
| POST /endpoints/{id}/heartbeat | 120 req/min | 2Hz max |

### Identifier Logic

Rate limits applied based on:
1. **User ID** (JWT or API token) - most specific
2. **Endpoint ID** (endpoint token) - agent-specific
3. **IP Address** (fallback) - unauthenticated requests

### Handling 429 Responses

**Python Example**:
```python
import time
import requests

def call_api_with_retry(url, headers):
    max_retries = 5
    for attempt in range(max_retries):
        response = requests.get(url, headers=headers)
        
        if response.status_code == 429:
            retry_after = int(response.headers.get('Retry-After', 60))
            wait_time = retry_after * (2 ** attempt)
            print(f"Rate limited. Waiting {wait_time}s...")
            time.sleep(wait_time)
            continue
            
        return response
```

**Bash Example**:
```bash
# Check headers
curl -i https://crontopus.com/api/runs
# X-RateLimit-Limit: 60
# X-RateLimit-Remaining: 42
# X-RateLimit-Reset: 1700000000

# On 429, script should:
# 1. Read Retry-After header
# 2. Wait specified seconds
# 3. Retry with exponential backoff
```

---

## Migration Guide

### For Existing Agents (Phase 17.1)

**Status**: ✅ **No Action Required**

- Check-in authentication is **backward compatible**
- Agents already include endpoint tokens in check-in calls
- Backend accepts check-ins with or without tokens (migration period)
- Future: Tokens will become required (Phase 17.5 - TBD)

**Verification**:
```bash
# Check agent token file exists
ls -la ~/.crontopus/agent-token

# Check agent logs for successful check-ins
grep "check-in" ~/.crontopus/agent.log
```

### For CI/CD Pipelines (Phase 17.2)

**Action**: Replace JWT tokens with API tokens

**Why**: JWT tokens expire after 7 days, breaking automation

**Steps**:

1. **Create API Token**:
   - Login to https://crontopus.com
   - Settings → API Tokens → Create Token
   - Name: "GitHub Actions" or "Jenkins Pipeline"
   - Scopes: Select required permissions
   - Expiry: 90 days (recommended) or never
   - **Copy token immediately!**

2. **Update CI/CD Secrets**:
```bash
# GitHub Actions
# Settings → Secrets → Actions → New repository secret
# Name: CRONTOPUS_API_TOKEN
# Value: ctp_...

# GitLab CI
# Settings → CI/CD → Variables → Add variable
# Key: CRONTOPUS_API_TOKEN
# Value: ctp_...
# Protected: Yes, Masked: Yes

# Jenkins
# Manage Jenkins → Credentials → Add credentials
# Kind: Secret text
# Secret: ctp_...
# ID: crontopus-api-token
```

3. **Update Pipeline Scripts**:
```yaml
# GitHub Actions - Before
- name: Deploy Jobs
  env:
    TOKEN: ${{ secrets.CRONTOPUS_JWT_TOKEN }}  # ❌ Old (expires)
  run: |
    curl -H "Authorization: Bearer $TOKEN" ...

# GitHub Actions - After
- name: Deploy Jobs
  env:
    TOKEN: ${{ secrets.CRONTOPUS_API_TOKEN }}  # ✅ New (long-lived)
  run: |
    curl -H "Authorization: Bearer $TOKEN" ...
```

4. **Test Integration**:
```bash
# Verify token works
curl -H "Authorization: Bearer ctp_..." \
  https://crontopus.com/api/auth/me

# Should return user info (200 OK)
```

5. **Delete Old JWT-Based Credentials**

### For Custom Scripts

**Action**: Add rate limit handling

**Example - Before**:
```bash
#!/bin/bash
curl https://crontopus.com/api/runs?limit=100
```

**Example - After**:
```bash
#!/bin/bash

call_api() {
    local url=$1
    local max_retries=5
    local attempt=0
    
    while [ $attempt -lt $max_retries ]; do
        response=$(curl -s -w "\n%{http_code}" "$url")
        http_code=$(echo "$response" | tail -n1)
        
        if [ "$http_code" = "200" ]; then
            echo "$response" | sed '$d'
            return 0
        elif [ "$http_code" = "429" ]; then
            wait_time=$((30 * (2 ** attempt)))
            echo "Rate limited. Waiting ${wait_time}s..." >&2
            sleep $wait_time
            ((attempt++))
        else
            echo "Error: $http_code" >&2
            return 1
        fi
    done
}

call_api "https://crontopus.com/api/runs?limit=100"
```

---

## Security Best Practices

### Token Management

1. **Never Commit Tokens**:
```bash
# Add to .gitignore
echo "*.token" >> .gitignore
echo "config.yaml" >> .gitignore
echo ".env" >> .gitignore
```

2. **Use Environment Variables**:
```bash
# Good
export CRONTOPUS_API_TOKEN="ctp_..."
curl -H "Authorization: Bearer $CRONTOPUS_API_TOKEN" ...

# Bad
curl -H "Authorization: Bearer ctp_..." ...  # Visible in shell history
```

3. **Rotate Regularly**:
```bash
# Create new token
NEW_TOKEN=$(curl -X POST ... | jq -r '.token')

# Update secrets in CI/CD
# ...

# Revoke old token
curl -X DELETE https://crontopus.com/api/tokens/OLD_ID
```

4. **Principle of Least Privilege**:
```json
{
  "scopes": ["read:runs", "write:jobs"]  // ✅ Only what's needed
}
```
vs
```json
{
  "scopes": ["admin:*"]  // ❌ Too broad
}
```

5. **Never Log Tokens**:
```python
# Bad
logger.info(f"Using token: {token}")

# Good
logger.info("Authenticating with API token")
```

### Rate Limit Guidelines

1. **Batch Operations**:
```bash
# Bad: 100 individual requests
for i in {1..100}; do curl ...; done

# Good: Single request with filter
curl "https://crontopus.com/api/runs?limit=100"
```

2. **Monitor Headers**:
```python
response = requests.get(url)
remaining = int(response.headers.get('X-RateLimit-Remaining', 0))

if remaining < 10:
    print("Warning: Approaching rate limit")
```

3. **Implement Backoff**:
- Always respect `Retry-After` header
- Use exponential backoff (2s → 4s → 8s → 16s → 32s)
- Max 5 retries recommended

4. **Job Frequency**:
```yaml
# Minimum: 1 minute intervals
schedule: "* * * * *"        # ✅ OK (60 check-ins/hour)

# Avoid: Sub-minute intervals
schedule: "*/30 * * * * *"   # ❌ Not supported (cron doesn't support seconds)
```

---

## Troubleshooting

### 401 Unauthorized

**Causes**:
- Missing Authorization header
- Invalid token format
- Expired token (JWT or API token)
- Token revoked

**Solutions**:
```bash
# 1. Verify token format
echo $TOKEN
# Should start with: eyJ... (JWT) or ctp_... (API token) or ep_... (endpoint)

# 2. Test token
curl -H "Authorization: Bearer $TOKEN" \
  https://crontopus.com/api/auth/me

# 3. Check expiration (API tokens)
curl -H "Authorization: Bearer <jwt>" \
  https://crontopus.com/api/tokens
# Look for expires_at field

# 4. Create new token if expired
```

### 429 Too Many Requests

**Causes**:
- Exceeded rate limit for endpoint
- Too many requests in short period
- Multiple clients sharing same token

**Solutions**:
```bash
# 1. Check rate limit headers
curl -i https://crontopus.com/api/runs
# X-RateLimit-Remaining: 0
# Retry-After: 30

# 2. Wait and retry
sleep 30
curl https://crontopus.com/api/runs

# 3. Implement exponential backoff (see examples above)

# 4. Review request frequency
# - Batch operations when possible
# - Use pagination instead of multiple requests
# - Cache responses when appropriate
```

### Agent Check-in Failures

**Causes**:
- Missing endpoint token file
- Incorrect file permissions
- Token doesn't match backend

**Solutions**:
```bash
# 1. Verify token file
ls -la ~/.crontopus/agent-token
# Should be: -rw------- (0600)

# 2. Check token format
cat ~/.crontopus/agent-token
# Should start with: ep_...

# 3. Re-enroll agent if needed
./crontopus-agent --config config.yaml
# Note: Creates NEW endpoint entry

# 4. Check agent logs
grep "401\|check-in" ~/.crontopus/agent.log
```

---

## API Reference

For complete API documentation, see: [docs/api-reference.md](api-reference.md)

**Key Endpoints**:
- Authentication: [docs/api-reference.md#authentication](api-reference.md#authentication)
- Rate Limiting: [docs/api-reference.md#rate-limiting](api-reference.md#rate-limiting)
- API Tokens: [docs/api-reference.md#api-tokens](api-reference.md#api-tokens)

---

## Support

- **Documentation**: https://docs.crontopus.com
- **Issues**: https://github.com/crontopus/crontopus/issues
- **Security**: security@crontopus.com
